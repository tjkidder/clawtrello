<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Kanban</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-slate-100 text-slate-900">
  <div class="flex h-screen">
    <aside class="w-64 bg-white border-r p-4">
      <h1 class="font-bold text-2xl">OpenClaw</h1>
      <p class="text-xs text-slate-500 mb-4">MANAGEMENT SYSTEM</p>
      <div class="space-y-2 text-sm">
        <div class="bg-blue-50 text-blue-700 p-2 rounded">Board</div>
        <div class="p-2">Agents</div>
      </div>
      <div class="mt-8 border rounded p-3">
        <div class="text-xs text-slate-500 mb-1">System Health</div>
        <div class="text-sm font-semibold">Active Nodes 12/12</div>
      </div>
    </aside>

    <main class="flex-1 flex flex-col">
      <header class="bg-white border-b p-4">
        <h2 class="text-2xl font-bold mb-3">Project: Alpha Board</h2>
        <form id="newTaskForm" class="grid grid-cols-1 md:grid-cols-4 gap-2">
          <input id="title" class="border rounded px-2 py-2" placeholder="New task title" required />
          <input id="dueAt" type="datetime-local" class="border rounded px-2 py-2" />
          <textarea id="description" class="border rounded px-2 py-2 md:col-span-2" placeholder="Task description (optional)"></textarea>
          <button class="bg-blue-600 text-white rounded px-3 py-2 md:col-start-4">New Task</button>
        </form>
      </header>

      <div class="px-4 pt-2 text-xs text-slate-500">
        Tip: drag cards between columns, or use action buttons.
      </div>
      <div class="p-4 flex gap-4 overflow-x-auto" id="board"></div>
    </main>
  </div>

<script>
const stages = [
  ['backlog', 'Backlog'],
  ['in_progress', 'In Progress'],
  ['review', 'Review'],
  ['blocked', 'Blocked'],
  ['done', 'Done']
];

let cards = [];
let agents = [];
let draggingCardId = null;

function escapeHtml(value) {
  return String(value)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('\"', '&quot;')
    .replaceAll("'", '&#039;');
}

function badge(stage){
  const m = { backlog:'bg-slate-200', in_progress:'bg-blue-100 text-blue-700', review:'bg-orange-100 text-orange-700', blocked:'bg-red-100 text-red-700', done:'bg-green-100 text-green-700'};
  return m[stage] || 'bg-slate-100';
}

async function moveCard(cardId, stage) {
  await fetch(`/api/cards/${cardId}/move`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ stage })
  });
}

function render(){
  const board = document.getElementById('board');
  board.innerHTML = '';

  for (const [key, label] of stages){
    const col = document.createElement('section');
    col.className = 'min-w-[280px] bg-slate-50 border rounded p-3';
    col.dataset.stage = key;
    const stageCards = cards.filter(c => c.stage === key);

    col.innerHTML = `<div class="flex items-center justify-between mb-3"><h3 class="font-bold">${label}</h3><span class="text-xs bg-slate-200 rounded-full px-2">${stageCards.length}</span></div>`;

    col.addEventListener('dragover', (e) => {
      e.preventDefault();
      col.classList.add('ring-2', 'ring-blue-300');
    });

    col.addEventListener('dragleave', () => {
      col.classList.remove('ring-2', 'ring-blue-300');
    });

    col.addEventListener('drop', async (e) => {
      e.preventDefault();
      col.classList.remove('ring-2', 'ring-blue-300');
      if (!draggingCardId) return;
      const dragged = cards.find((c) => c.id === draggingCardId);
      if (!dragged || dragged.stage === key) return;
      await moveCard(draggingCardId, key);
      draggingCardId = null;
    });

    stageCards.forEach(card => {
      const el = document.createElement('article');
      el.className = 'bg-white border rounded p-3 mb-2 space-y-2 cursor-grab';
      el.draggable = true;
      const due = card.dueAt ? new Date(card.dueAt).toLocaleString() : 'No due date';
      const agentOptions = ['<option value="">Unassigned</option>'].concat(
        agents.map(a => `<option value="${a.agentId}" ${a.agentId===card.assigneeAgentId?'selected':''}>${a.emoji} ${a.name}</option>`)
      ).join('');
      const description = card.description ? `<div class="text-xs text-slate-600 whitespace-pre-wrap">${escapeHtml(card.description)}</div>` : '';

      el.innerHTML = `
        <div class="font-semibold">${escapeHtml(card.title)}</div>
        ${description}
        <div class="text-xs text-slate-500">${due}</div>
        <div class="text-xs"><span class="px-2 py-1 rounded ${badge(card.stage)}">${card.stage}</span></div>
        <select data-id="${card.id}" class="assign w-full border rounded px-2 py-1 text-sm">${agentOptions}</select>
        <div class="flex gap-1 flex-wrap">
          ${key !== 'in_progress' ? `<button data-id="${card.id}" data-stage="in_progress" class="move text-xs px-2 py-1 border rounded">In Progress</button>`:''}
          ${key !== 'review' ? `<button data-id="${card.id}" data-stage="review" class="move text-xs px-2 py-1 border rounded">Review</button>`:''}
          ${key === 'review' ? `<button data-id="${card.id}" class="approve text-xs px-2 py-1 bg-green-600 text-white rounded">Approve</button>`:''}
          ${key !== 'blocked' ? `<button data-id="${card.id}" data-stage="blocked" class="move text-xs px-2 py-1 border rounded">Block</button>`:''}
        </div>`;

      el.addEventListener('dragstart', () => {
        draggingCardId = card.id;
      });

      el.addEventListener('dragend', () => {
        draggingCardId = null;
      });

      col.appendChild(el);
    });

    board.appendChild(col);
  }

  document.querySelectorAll('.move').forEach(btn => btn.onclick = async (e) => {
    const { id, stage } = e.target.dataset;
    await moveCard(id, stage);
  });

  document.querySelectorAll('.approve').forEach(btn => btn.onclick = async (e) => {
    const { id } = e.target.dataset;
    await fetch(`/api/cards/${id}/approve`, { method:'POST' });
  });

  document.querySelectorAll('.assign').forEach(sel => sel.onchange = async (e) => {
    const id = e.target.dataset.id;
    const agentId = e.target.value;
    if (!agentId) return;
    await fetch(`/api/cards/${id}/assign`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ agentId })});
  });
}

async function bootstrap(){
  const [cardsRes, agentsRes] = await Promise.all([fetch('/api/cards'), fetch('/api/agents')]);
  cards = (await cardsRes.json()).cards;
  agents = (await agentsRes.json()).agents;
  render();
}

const socket = io();
['card.created','card.moved','card.assigned','card.approved'].forEach(evt => socket.on(evt, async () => bootstrap()));
socket.on('agents.updated', (a) => { agents = a; render(); });

document.getElementById('newTaskForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('title').value;
  const dueAt = document.getElementById('dueAt').value;
  const description = document.getElementById('description').value;
  await fetch('/api/cards', {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ title, dueAt: dueAt || undefined, description: description || undefined })
  });
  e.target.reset();
});

bootstrap();
</script>
</body>
</html>
